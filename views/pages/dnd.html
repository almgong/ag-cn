<!DOCTYPE html>

<html>
	<head>
		<title>AG Games | ag-cn</title>
		<meta charset="utf-8" />

		<!-- styles -->
		<link href='https://fonts.googleapis.com/css?family=Actor' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" type="text/css" href="/static/css/animate.css" />
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/tooltipster/3.3.0/css/tooltipster.min.css" />
		<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css" />
		<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
		<link rel="stylesheet" type="text/css" href="/static/css/site.css" />

		<style>
			.dnd-text-box {
				border: 1px solid black;
				height: 200px;
				overflow: scroll;
				padding: 15px;
				margin-bottom:15px;
			}
			#dice-rolling-animation {
				display: none;
			}
			#add-enemy-btn {
				margin: 5px 0;
				padding: 2px;
			}
			.tool-btn {
				cursor: pointer;
			}
		</style>
	</head>

	<body>
		<!-- top nav -->
		<nav class="navbar navbar-default">
		  <div class="container-fluid">
		    <div class="navbar-header">
		    	<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-dropdown" aria-expanded="false">
		        <span class="sr-only">Toggle navigation</span>
		        <span class="icon-bar"></span>
		        <span class="icon-bar"></span>
		        <span class="icon-bar"></span>
		      </button>
		      <a class="navbar-brand" href="/">
		        <span class="brand-blue">AG</span>-<span class="brand-red">Games</span>
		      </a>
		    </div>

		    <!-- encapsulated in dropdown for mobile -->
		    <div class="collapse navbar-collapse" id="nav-dropdown">
		    	<ul class="nav navbar-nav navbar-right">
			        <li class="active"><a href="/">Home <span class="sr-only">(current)</span></a></li>
			      </ul>
		    </div>
		  </div>
		</nav>

		<div class="container">
			<div class="row">
				<h2>Dungeons &amp; Dragons</h2>
				<div class="col-sm-offset-1 col-sm-6">
						Dice rolling
						<hr>
						<div>
							<form id="dice-form">
								<div class="form-group">
									<label class="" for="dice-input">Enter dice type (e.g. 3d4, 1d8, 1d10, 1d20...) </label>
									<input id="dice-input" class="form-control" type="text" />
								</div>

								<div class="form-group">
									<input type="submit" value="Roll" />
									<i id="dice-rolling-animation" class="fa fa-spinner fa-spin"></i>
								</div>

							</form>
						</div>
						<hr />
						<div class="dice">
							<div>Dice Type: <span id="dice-type"></span></div>
							<div>Dice Value: <span id="dice-value"></span></div>
						</div>
						<hr />
						Enemies:
						<div id="add-enemy-btn">
							<button class="btn btn-primary" data-toggle="modal" data-target="#enemy-modal">
								<i class="fa fa-cog"></i>
							</button>
						</div>
						<div id="enemy-box" class="dnd-text-box">
							<ul class="list-group">
								<!-- genereated in JS -->
							</ul>
						</div>
				</div>
				<div class="col-sm-5">
					<div class="row">
						Team board:
						<div id="chat-box" class="dnd-text-box"></div>
						<div>
							<form id="chat-box-form">
								
								<div class="form-group">
									<label for="chat-box-name" class="disabled">Your name: &nbsp;&nbsp;&nbsp;</label>
									<input type="text" id="chat-box-name" />
								</div>
								
								<div class="form-group">
									<label for="chat-box-text">Write to board: &nbsp;&nbsp;&nbsp;</label>
									<input id="chat-box-text" type="text" />
									<input type="submit" value="Send" />
								</div>
							</form>
						</div>
					</div>
					<hr/>
					<div class="row">
						<form>
							Personal Notes:
							<textarea id="personal-notes" class="dnd-text-box form-control"></textarea>
						</form>
					</div>
				</div>
			</div>
		</div>


		<div class="modal fade" id="enemy-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title">Edit enemies</h4>
		      </div>
		      <div class="modal-body">
		        <div>
		        	<div>
		        		<form id="new-enemy-form">
		        			<label for="new-enemy-input">Add enemy:</label>
		        			<input id="new-enemy-input" type="text" />
		        			<input type="submit" value="Go" />
		        		</form>
		        	</div>
		        	<hr />
		        	<ul id="enemy-modal-list" class="list-group">
		        		<!-- generated in JS -->
		        	</ul>
		        </div>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
		        <button id="save-enemies-btn" type="button" class="btn btn-primary">Save changes</button>
		      </div>
		    </div>
		  </div>
		</div>


		<!-- script -->
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
		<script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
		<script type="text/javascript">

		// module for storing information persistently. Currently 
		// utilizes localStorage (note an instance is never needed to save)
		// expects a prefix that will be prepended to all keys stored (organization)
		var PStorage = (function(storagePrefix) {
			// main key to pass in localStorage.get() == MAIN_STORAGE_KEY
			
			// stores/updates arbitrary data with the key (can be objects as well as strings)
			var store = function(key, value) {
				window.localStorage.setItem(storagePrefix+"-" + key, JSON.stringify(value));
			};

			// returns the item, or null if DNE
			var get = function(key) {
				return JSON.parse(window.localStorage.getItem(storagePrefix+"-"+key));
			};

			return {
				store:store,
				get:get
			};
		});

		// main
		$(function() {
			var GameManagerDnD = (function() {
				var storage = new PStorage("dnd");	// for storing persistent info
				var lastMessageIndex = 0;			// index of last message placed on team chat

				// DOM
				var $chatBox = $('#chat-box');
				var $enemyBox = $('#enemy-box');
				var $enemyModal = $('#enemy-modal');
				var $enemyModalList = $('#enemy-modal-list');
				var $saveEnemiesBtn = $('#save-enemies-btn');
				var $newEnemyForm = $('#new-enemy-form');
				var $newEnemyInput = $('#new-enemy-input');
				var $diceType = $('#dice-type');
				var $diceValue = $('#dice-value');
				var $personalNotes = $('#personal-notes');
				var $chatName = $('#chat-box-name');
				var $diceAnimation = $('#dice-rolling-animation');

				// local state
				var currentEnemies = [];	// [{enemyId:x, text:"..."}, ...]
				var nextEnemyId = 0;		// unique id for each enemy

				var api = {
					updateTeamChat:function(msgStr) {
						// POST /dnd/chat

						var msg = {
							message:msgStr,
							messageTimestamp:new Date()
						};

						$.ajax({
							url:"/dnd/chat",
							method:"POST",
							data:msg,
							success:function(d) {
								console.log("POSTed team chat message");
								$('#chat-box-text').val("");
							},
							error:function() {
								console.log("Could not POST team chat message");
							}
						});
					},
					getTeamChat:function() {
						// GET /dnd/chat
						$.ajax({
							url:"/dnd/chat/"+ lastMessageIndex,
							method:"GET",
							success:function(d) {
								updateTeamChatUI(d);
							},
							error:function() {
								console.log("Error, Disconnect?")
							}
						});
					},
					updateDice:function(d) {
						// include name in dice roll!
						d.rollerName = $chatName.val();

						// POST /dnd/dice
						$.ajax({
							url:"/dnd/dice",
							method: "POST",
							data:d,
							success:function(d) {
								console.log("udated dice value to origin");
								//$diceAnimation.css("display", "none");
							},
							error:function() {
								console.log("unable to update dice roll value.");
							}
						}); 
					},
					getDice:function() {
						// GET /dnd/dice
						$.ajax({
							url:"/dnd/dice",
							method:"GET",
							success:function(d) {
								// update UI
								updateDiceUI(d);

							},
							error:function() {
								console.log("Could not get dice, Disconnect?");
							}
						});
					},
					updateEnemies:function(enemies) {
						
						var enemiesNow = enemies;
						console.log(enemiesNow)
						// enemy should have a text value and an integer id
						$.ajax({
							url:"/dnd/enemy",
							method: "POST",
							contentType:'application/json',
							data:JSON.stringify(enemiesNow),
							success:function(d) {
								console.log("POSTed new enemy.");
								console.log(enemies)
							},
							error:function() {
								console.log("Could not POST new enemy...");
							}
						});
					},
					getEnemies:function() {
						$.ajax({
							url:"/dnd/enemy",
							method:"GET",
							success:function(d) {
								console.log(d);
								currentEnemies = d.enemies;
								updateEnemiesUI(d);
							}, 
							error:function() {
								console.log("Could not get enemeies...");
							}
						});
					},
					getAllState:function() {
						$.ajax({
							url:"/dnd/all/" + lastMessageIndex,
							method:"GET",
							success:function(d) {
								// update any local state
								currentEnemies = d.enemies;

								// update UI
								updateDiceUI(d.dice);
								updateTeamChatUI(d.chatMessages);
								updateEnemiesUI(d.enemies);
								$diceAnimation.css("display", "none");
							},
							error:function() {
								console.log("Could not get all state, disconnect?");
							}
						});
					}
				};

				function updateTeamChatUI(newMessages) {
					for (var index = 0; index< newMessages.length; index++) {
						var newDiv = document.createElement("div");
						newDiv.setAttribute("class", "chat-box-item");
						newDiv.innerHTML = "-- " + newMessages[index].message;
						$chatBox[0].appendChild(newDiv);
					}
	
					$chatBox[0].scrollTop = $chatBox[0].scrollHeight;
					lastMessageIndex += (index);
				}

				function updateDiceUI(params) {
					$diceType.text(params.diceType);

					if (params.rollValue) {
						$diceValue.text(params.rollerName + " rolled " + params.rollValue + "!");
					}
				}

				function updateEnemiesUI(enemies) {
					// enemies local var contains newest list of enemies
		
					// update local state and redraw
					var $ul = $enemyBox.children("ul");
					$ul.empty();
					currentEnemies = enemies;			// we need currentEnemies for editing only

					// generate + append enemies-box dom elements
					for (var i = 0; i < enemies.length; i++) {

						// for the enemies box display
						var li = document.createElement("li");
						li.setAttribute("class", "list-group-item");
						li.innerHTML = enemies[i].text;

						$ul[0].appendChild(li);
					}	
				}

				function saveLocalState() {
					// notes
					storage.store("notes", $personalNotes.val());

					// chat name
					storage.store("name", $chatName.val());
				}

				var rollDice = function(max) {
					return 1+Math.ceil(Math.random()*(max-1));
				};

				var start = function() {
					// really just a matter of setting intervals

					// NEW used a coupled endpoint for both chat and dice
					setInterval(api.getAllState, 1200);

					setInterval(saveLocalState, 5000);

					// restore needed state
					var notes = storage.get("notes");
					if (notes) {
						notes = notes.replace(/\r\n?|\\n/g, '<br />');
						$personalNotes.val(notes);
					}

					var name = storage.get("name");
					if (!name) {
						name = ("anon-" + Math.ceil(Math.random()*10000));
					} 

					$chatName.val(name);


					// events
					$('#add-enemy-btn').on("click", function(e) {
						e.preventDefault();

						// repopulate enemy modal
						$enemyModalList.empty();
						for (var i = 0; i < currentEnemies.length; i++) {
							// for the enemies modal
							var liModal = document.createElement("li");
							liModal.setAttribute("class", "list-group-item");
							liModal.setAttribute("data-enemy-id", currentEnemies[i].enemyId);
							liModal.innerHTML = "<i class='tool-btn delete-enemy-btn fa fa-times pull-right'></i>";

							var input = document.createElement("input");
							input.setAttribute("value", currentEnemies[i].text);
							liModal.appendChild(input);

							$enemyModalList[0].appendChild(liModal);
						}

						// bind delete button
						$('.delete-enemy-btn').on("click", function() {
							$(this).parent().remove();
						});
					});

					$saveEnemiesBtn.on("click", function(e) {
						
						// get all enemies shown in modal
						var $enemiesListItems = $enemyModalList.children("li");	// should preserve DOM order 
						var newEnemiesList = [];

						for (var i = 0; i < $enemiesListItems.length; i++) {
							console.log($($enemiesListItems).children("input").val())
							newEnemiesList.push({
								"enemyId": +$enemiesListItems[i].getAttribute("data-enemy-id"),
								"text": $($enemiesListItems[i]).children("input").val()
							});
						}

						// don't redraw UI here, let next iteration do it so everyone sees it at same time!
						api.updateEnemies(newEnemiesList);

						$enemyModal.modal("hide");
					});

					$newEnemyForm.on("submit", function(e) {
						e.preventDefault();

						// quickly find the largest id to determine this enemy's id
						var enemiesInList = $enemyModalList.children("li");
						var enemyId = 0;
						if (enemiesInList.length > 0) {
							enemyId = 
								1 + (+enemiesInList[enemiesInList.length-1].getAttribute("data-enemy-id"));
						} 

						// just append it to the DOM (save changes button will POST updates)
						var li = document.createElement("li");
						li.setAttribute("class", "list-group-item");
						li.setAttribute("data-enemy-id", enemyId);
						li.innerHTML = "<i class='tool-btn delete-enemy-btn fa fa-times pull-right'></i>";

						var input = document.createElement("input");
						input.setAttribute("value", $newEnemyInput.val());
						li.appendChild(input);

						$enemyModalList[0].appendChild(li);
						$newEnemyInput.val("");
					});
				};

				return {
					start:start,
					rollDice:rollDice,
					updateDice:api.updateDice,
					updateTeamChat:api.updateTeamChat
				};

			});	

			// form events (should move form events to inside start())
			var gameManager = new GameManagerDnD();
			gameManager.start();
			$('#dice-form').on("submit", function(e) {
				e.preventDefault();

				$('#dice-rolling-animation').css("display", "inline-block");

				var diceTypeRaw = $('#dice-input').val();
				var diceType = diceTypeRaw.split("d");
				var rollTimes = +diceType[0];
				var rollValues = [];

				for (var i = 0; i < rollTimes; i++) {
					rollValues.push(gameManager.rollDice(diceType[1]));
				}

				gameManager.updateDice({"diceType":diceTypeRaw, "rollValue": JSON.stringify(rollValues)});

			});

			$('#chat-box-form').on("submit", function(e) {
				e.preventDefault();
				var msgStr = $('#chat-box-text').val();
				var name = ($('#chat-box-name').val())? $('#chat-box-name').val() : "anon.";

				msgStr = "(" + name + ") " + msgStr;
				gameManager.updateTeamChat(msgStr);
			});
		});
		</script>
	</body>
</html>